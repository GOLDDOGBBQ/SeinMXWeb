
@{
    ViewBag.Title = "Editar";
}

@model SEINMX.Models.Inventario.CotizacionViewModel

<div class="container mt-4">

    @if (Model.Cotizacion == null)
    {
        <button class="btn btn-primary"
                onclick="location.href='@Url.Action("Crear", "Cotizacion")'">
            Crear Cotización
        </button>
        <hr/>
    }
    else
    {
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger">
                @Html.ValidationSummary()
            </div>
        }

        <div class="row">
            <div class="col-md-3">
                <div class="info-box bg-info">
                    <div class="info-box-content">
                        <span class="info-box-text">Numero de cotizacion</span>
                        <span class="info-box-number">@Model.Cotizacion.IdCotizacion</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="info-box bg-success">
                    <div class="info-box-content">
                        <span class="info-box-text">Sub total</span>
                        <span class="info-box-number">@Model.Cotizacion.SubTotal</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="info-box bg-warning">
                    <div class="info-box-content">
                        <span class="info-box-text">IVA</span>
                        <span class="info-box-number">@Model.Cotizacion.PorcentajeIva</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="info-box bg-primary">
                    <div class="info-box-content">
                        <span class="info-box-text">Total</span>
                        <span class="info-box-number">@Model.Cotizacion.Total</span>
                    </div>
                </div>
            </div>
        </div>

        <form id="formCotizacion" method="post" action="@Url.Action("Guardar", "Cotizacion")">
            @Html.HiddenFor(m => m.Cotizacion!.IdCotizacion)



            <div class="card card-primary mt-3">
                <div class="card-header">
                    <h3 class="card-title">Datos generales</h3>
                </div>

                <div class="card-body">

                    <div class="row">

                        <!-- Fecha -->
                        <div class="col-md-2">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="Cotizacion.Fecha" class="form-control"
                                   value="@Model.Cotizacion.Fecha?.ToString("yyyy-MM-dd")">
                        </div>

                        <!-- Tipo de Cambio -->
                        <div class="col-md-2">
                            <label class="form-label">Tipo Cambio</label>
                            <input type="number" step="0.0001" name="Cotizacion.TipoCambio"
                                   class="form-control"
                                   value="@Model.Cotizacion.TipoCambio">
                        </div>

                        <!-- Tarifa -->
                        <div class="col-md-2">
                            <label class="form-label">Tarifa (%)</label>
                            <input type="number" step="0.0001" name="Cotizacion.Tarifa"
                                   class="form-control"
                                   value="@Model.Cotizacion.Tarifa">
                        </div>

                        <!-- IVA -->
                        <div class="col-md-2">
                            <label class="form-label">IVA (%)</label>
                            <input type="number" step="0.0001" name="Cotizacion.PorcentajeIVA"
                                   class="form-control"
                                   value="@Model.Cotizacion.PorcentajeIva">
                        </div>

                        <!-- Descuento -->
                        <div class="col-md-2">
                            <label class="form-label">Descuento ($)</label>
                            <input type="number" step="0.0001" name="Cotizacion.Descuento"
                                   class="form-control"
                                   value="@Model.Cotizacion.Descuento">
                        </div>


                    </div>

                    <div class="row mt-3">
                        <!-- Usuario Responsable -->
                        <div class="col-md-3">
                            <label class="form-label">Usuario Responsable</label>
                            <select id="cmbUsuario" name="Cotizacion.UsuarioResponsable"
                                    class="form-control select2-ajax"
                                    data-url="/Utilerias/GetComboUsuarios"
                                    data-placeholder="Buscar usuario...">
                                @if (Model.Cotizacion.UsuarioResponsable != null)
                                {
                                    <option value="@Model.Cotizacion.UsuarioResponsable" selected>
                                        @Model.Cotizacion.Responsable
                                    </option>
                                }
                            </select>
                        </div>


                        <!-- Cliente -->
                        <div class="col-md-9">
                            <label class="form-label">Cliente</label>
                            <cb-dropdown
                                id="IdCliente"
                                name="Cotizacion.IdCliente"
                            >
                            </cb-dropdown>
                        </div>

                        <!-- Contacto -->

                        <div class="col-md-6">
                            <label class="form-label">Contacto</label>
                            <cb-dropdown
                                id="IdClienteContacto"
                                name="Cotizacion.IdClienteContacto"
                            >
                            </cb-dropdown>
                        </div>


                        <!-- Razón Social -->
                        <div class="col-md-6">
                            <label class="form-label">Razón Social</label>
                            <cb-dropdown
                                id="IdClienteRazonSolcial"
                                name="Cotizacion.IdClienteRazonSolcial"
                            >
                            </cb-dropdown>

                        </div>


                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label">Observaciones</label>
                            <textarea name="Cotizacion.Observaciones" class="form-control"
                                      rows="3">@Model.Cotizacion.Observaciones</textarea>
                        </div>
                    </div>

                </div>

                <div class="card-footer text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </form>
    }
</div>

<script type="module">
    import {ClientsDataProvider} from "../../dropdown-1.1.0/clientsDataProvider-1.1.1.js";

    // Dropdowns
    const clientesDropdown = document.querySelector("#IdCliente");
    const contactoDropdown = document.querySelector("#IdClienteContacto");
    const razonDropdown = document.querySelector("#IdClienteRazonSolcial");

    // Provider inicial del cliente
    clientesDropdown.dataProvider = new ClientsDataProvider(
        '/Cliente/DropdownClientes',
        'Buscar Cliente...'
    );

    // Provider inicial del contacto (sin cliente seleccionado)
    contactoDropdown.dataProvider = new ClientsDataProvider(
        '/Cliente/DropdownClienteContacto',
        'Buscar contacto...'
    );

    razonDropdown.dataProvider = new ClientsDataProvider(
        '/Cliente/DropdownClienteRazonSolcial',
        'Buscar razón social...'
    );


    clientesDropdown.setAttribute('selected', '@(Model.Cotizacion is { IdCliente: > 0 } ? Model.Cotizacion.IdCliente.ToString() : "")');
    contactoDropdown.setAttribute('selected', '@((Model.Cotizacion?.IdClienteContacto ?? 0) > 0 ? Model.Cotizacion?.IdClienteContacto.ToString() : "")');
    razonDropdown.setAttribute('selected', '@((Model.Cotizacion?.IdClienteRazonSolcial ?? 0) > 0 ? Model.Cotizacion?.IdClienteRazonSolcial.ToString() : "")');

    // CUANDO CAMBIA EL CLIENTE
    clientesDropdown.addEventListener("change", () => {
        const idCliente = clientesDropdown.selected;



        // Cambiar la URL del dataProvider del combo dependiente
        contactoDropdown.dataProvider.loadData = async ({page, pageSize, search}) => {
            const encodedSearch = encodeURIComponent(search);
            return await fetch(`/Cliente/DropdownClienteContacto?idCliente=${idCliente}&page=${page}&pageSize=${pageSize}&search=${encodedSearch}`)
                .then(r => r.json());
        }

        razonDropdown.dataProvider.loadData = async ({page, pageSize, search}) => {
            const encodedSearch = encodeURIComponent(search);
            return await fetch(`/Cliente/DropdownClienteRazonSolcial?idCliente=${idCliente}&page=${page}&pageSize=${pageSize}&search=${encodedSearch}`)
                .then(r => r.json());
        }

        //Limpiar la caché del provider
        contactoDropdown.dataProvider.reset();
        razonDropdown.dataProvider.reset()

            ////Limpiar la selección del combo
            contactoDropdown.setAttribute("selected", "");
            razonDropdown.setAttribute("selected", "")


        // Limpiar placeholder visible
        // contactoDropdown.shadowRoot.querySelector("span").textContent = contactoDropdown.placeholder;
        //razonoDropdown.shadowRoot.querySelector("span").textContent = contactoDropdown.placeholder;


    });
</script>
