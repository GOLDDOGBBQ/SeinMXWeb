
@{
    ViewBag.Title = "Editar Cotizacion";
    CultureInfo cultureMx = new CultureInfo("es-MX");

    var labelAtt = new
    {
        @@class = "form-label"
    };

    var labelValidation = new
    {
        @@class = "text-danger"
    };
    var editformAtt = new
    {
        htmlAttributes = new
        {
            @@class = "form-control"
        }
    };
}

@using System.Globalization
@using SEINMX.Clases.Helpers
@model SEINMX.Models.Inventario.CotizacionViewModel

<div class="container-fluid mt-4 px-0 px-sm-1 px-md-4">
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @ViewBag.Error
            @TempData["toast-error"]
            @Html.ValidationSummary()
        </div>
    }

    <!-- INFO Cotizacion -->
    <div class="row">
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon text-bg-success shadow-sm">
                    <i class="fa-solid fa-hashtag"></i>
                </span>

                <div class="info-box-content">
                    <span class="info-box-text">@Html.DisplayNameFor(model => model.Cotizacion)</span>
                    <span class="info-box-number">@Model.Cotizacion</span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon text-bg-success shadow-sm">
                    <i class="fa-solid fa-layer-group"></i>
                </span>

                <div class="info-box-content">
                    <span class="info-box-text">@Html.DisplayNameFor(model => model.Perfil)</span>
                    <span class="info-box-number">@Model.Perfil</span>
                </div>
            </div>
        </div>
    </div>



    <!-- FORM Cotizacion -->


    @using (Html.BeginForm("Guardar", "Cotizacion", FormMethod.Post))
    {
        @Html.HiddenFor(m => m.IdCotizacion)
        @Html.HiddenFor(m => m.Cotizacion)
        @Html.HiddenFor(m => m.Perfil)


        <div class="card card-secondary mt-3">
            <div class="card-header">
                <h3 class="card-title">Datos generales</h3>
            </div>

            <div class="card-body">

                <div class="row">
                    <div class="col-md-2">
                        <div class="form-group">
                            @Html.LabelFor(model => model.Status, labelAtt)
                            @Html.DropDownListFor(
                                m => m.Status,
                                Model.GetComboStatus(),
                                new { @class = "form-select", id = "Status", name = "Status" }
                            )
                            @Html.ValidationMessageFor(model => model.Status, "", labelValidation)
                        </div>
                    </div>

                    <!-- Fecha -->
                    <div class="col-md-2">
                        @Html.LabelFor(model => model.Fecha, labelAtt)
                        @Html.EditorFor(model => model.Fecha, editformAtt)
                        @Html.ValidationMessageFor(model => model.Fecha, "", labelValidation)

                    </div>

                    <!-- Tipo de Cambio -->
                    <div class="col-md-2">
                        @Html.LabelFor(model => model.TipoCambio, labelAtt)
                        @Html.EditorFor(model => model.TipoCambio, editformAtt)
                        @Html.ValidationMessageFor(model => model.TipoCambio, "", labelValidation)
                    </div>

                    <!-- Descuento -->
                    <div class="col-md-2">
                        @Html.LabelFor(model => model.Descuento, labelAtt)
                        @Html.EditorFor(model => model.Descuento, editformAtt)
                        @Html.ValidationMessageFor(model => model.Descuento, "", labelValidation)

                    </div>
                    <!-- Incluir Envio -->
                    <div class="col-md-2">
                        <label class="form-label">Términos y Condiciones</label>
                        <div class="form-check">
                            @Html.EditorFor(model => model.EsIncluirEnvio, new
                            {
                                htmlAttributes = new
                                {
                                    @class = "form-check-input"
                                }
                            })
                            @Html.LabelFor(model => model.EsIncluirEnvio, new
                            {
                                @class = "form-check-label"
                            })
                        </div>


                        @Html.ValidationMessageFor(model => model.EsIncluirEnvio, "", labelValidation)

                    </div>

                </div>

                <div class="row mt-3">
                    <!-- Usuario Responsable -->
                    <div class="col-md-3">
                        @Html.LabelFor(model => model.UsuarioResponsable, labelAtt)
                        @Html.DropDownListFor(
                            m => m.UsuarioResponsable,
                            (List<SelectListItem>)ViewBag.UsuariosResponsables,
                            new { @class = "form-select", id = "UsuarioResponsable", name = "UsuarioResponsable" }
                        )
                        @Html.ValidationMessageFor(model => model.UsuarioResponsable, "", labelValidation)

                    </div>


                    <!-- Cliente -->
                    <div class="col-md-9">
                        @Html.HiddenFor(model => model.IdCliente)
                        @Html.LabelFor(model => model.Cliente, labelAtt)
                        @Html.EditorFor(model => model.Cliente, new { htmlAttributes = new { @class = "form-control", disabled = "disabled" } })
                    </div>

                    <!-- Contacto -->

                    <div class="col-md-6">
                        @Html.LabelFor(model => model.IdClienteContacto, labelAtt)
                        <cb-dropdown
                            id="IdClienteContacto"
                            name="IdClienteContacto">
                        </cb-dropdown>
                        @Html.ValidationMessageFor(model => model.IdClienteContacto, "", labelValidation)
                    </div>


                    <!-- Razón Social -->
                    <div class="col-md-6">
                        @Html.LabelFor(model => model.IdClienteRazonSolcial, labelAtt)
                        <cb-dropdown
                            id="IdClienteRazonSolcial"
                            name="IdClienteRazonSolcial">
                        </cb-dropdown>
                        @Html.ValidationMessageFor(model => model.IdClienteRazonSolcial, "", labelValidation)
                    </div>


                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        @Html.LabelFor(model => model.Observaciones, labelAtt)
                        @Html.EditorFor(model => model.Observaciones, editformAtt)
                        @Html.ValidationMessageFor(model => model.Observaciones, "", labelValidation)
                    </div>
                </div>

            </div>

            <div class="card-footer text-end">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    }

    <!-- Agregar Productos FORM -->
    <div class="card card-secondary mt-3">
        <div class="card-header">
            <h3 class="card-title">Agregar Producto</h3>
        </div>
        <div class="card-body">

            <!-- Combo cb-dropdown -->
            <cb-dropdown id="IdProducto" name="IdProducto"></cb-dropdown>

            <div class="row mt-3">
                <div class="col-md-2">
                    <label>Cantidad</label>
                    <input type="number" id="txtCantidad" class="form-control" value="1" step="0.0001">
                </div>
                <div class="col-md-10">
                    <label>Observaciones</label>
                    <input type="text" id="txtObsProd" class="form-control">
                </div>
            </div>

        </div>
        <div class="card-footer text-end">
            <button id="btnAgregarProducto" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar
            </button>
        </div>
    </div>

    <!-- Agregar Productos TABLA-->
    <div class="card mt-3">
        <div class="card-header">
            <b>Productos</b>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mt-4 " id="tablaDetalle">
                    <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        @if (UserClaimsHelper.IsAdmin(User))
                        {
                            <th>Precio Lista</th>
                            <th>% Prov</th>
                            <th>Precio Prov</th>
                            <th>% Gan</th>
                            <th>Ganancia</th>
                            <th>Precio Sein</th>
                        }
                        <th>Precio Cliente</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                        <th>Observaciones</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TOTALES -->
    <div class="row  mt-3">
        <div class="col-md-3">
            <div class="info-box">
                    <span class="info-box-icon text-bg-success shadow-sm">
                        <i class="fa-solid fa-filter-circle-dollar"></i>
                    </span>

                <div class="info-box-content">
                    <span class="info-box-text">Sub total</span>
                    <span class="info-box-number" id="infoSubTotal"
                          name="infoSubTotal">
                            @string.Format(cultureMx, "{0:C}", Model.SubTotal)
                        </span>
                </div>
            </div>

        </div>


        <div class="col-md-3">
            <div class="info-box">
                    <span class="info-box-icon text-bg-success shadow-sm">
                        <i class="fa-solid fa-building-columns"></i>
                    </span>

                <div class="info-box-content">
                    <span class="info-box-text">IVA</span>
                    <span class="info-box-number" id="infoIva" name="infoIva">
                            @string.Format(cultureMx, "{0:C}", Model.Iva)
                        </span>
                </div>
            </div>

        </div>

        <div class="col-md-3">
            <div class="info-box">
                    <span class="info-box-icon text-bg-success shadow-sm">
                        <i class="fa-solid fa-sack-dollar"></i>
                    </span>

                <div class="info-box-content">
                    <span class="info-box-text">Total</span>
                    <span class="info-box-number" id="infoTotal" name="infoTotal">
                            @string.Format(cultureMx, "{0:C}", Model.Total)
                        </span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="info-box">
                    <span class="info-box-icon text-bg-success shadow-sm">
                        <i class="fa-regular fa-file-pdf"></i>
                    </span>

                <div class="info-box-content">
                    <a class="OpenSideNav text-white btn btn-sm btn-secondary"
                       style="--bs-btn-padding-y: 0.25rem; --bs-btn-padding-x: 0.5rem; --bs-btn-font-size: 0.75rem; "
                       href="@Url.Action("GenerarPdf", "Cotizacion", new { idCotizacion = Model.IdCotizacion })"
                       target="frameCB"> <i class="fa-solid fa-eye"></i> Ver</a>


                    <a class="btn btn-secondary mt-1"
                       style="--bs-btn-padding-y: 0.25rem; --bs-btn-padding-x: 0.5rem; --bs-btn-font-size: 0.75rem; "
                       href="@Url.Action("GenerarPdf", "Cotizacion", new { idCotizacion = Model.IdCotizacion, file = true })">
                        <i class="fa-solid fa-download"></i> Descargar
                    </a>

                </div>
            </div>
        </div>
    </div>

    <!-- PREVIEW PDF -->
    <div class="row">
        <div id="SideframeCB" class="sidenav col-12 col-sm-12 col-md-10 col-lg-6 ">
            <a class="closebtn CloseSideNav" data-itn-sidenav="SideframeCB"
               data-itn-frame="frameCB">&times;Cerrar</a>
            <iframe id="frameCB" name="frameCB" class="border-0 h-100 col-12 col-md-12 col-lg-12"></iframe>
        </div>
    </div>





    <script type="module">
        import {ClientsDataProvider} from "@UrlExtensions.Absolute("/dropdown-1.1.0/clientsDataProvider-1.1.1.js ")";

        const ProductDropdown = document.querySelector("#IdProducto");
        ProductDropdown.dataProvider = new ClientsDataProvider('/Producto/DropdownProducto', 'Buscar Producto...');

    </script>

    <script type="module">
        import {ClientsDataProvider} from "@UrlExtensions.Absolute("/dropdown-1.1.0/clientsDataProvider-1.1.1.js ")";

        const contactoDropdown = document.querySelector("#IdClienteContacto");
        const razonDropdown = document.querySelector("#IdClienteRazonSolcial");

        contactoDropdown.dataProvider = new ClientsDataProvider(
            '@Url.Action("DropdownClienteContacto", "Cliente")',
            'Buscar contacto...'
        );

        razonDropdown.dataProvider = new ClientsDataProvider(
            '@Url.Action("DropdownClienteRazonSolcial", "Cliente")',
            'Buscar razón social...'
        );


        contactoDropdown.dataProvider.loadData = async ({page, pageSize, search}) => {
            const encodedSearch = encodeURIComponent(search);
            return await fetch(`@Url.Action("DropdownClienteContacto", "Cliente")?idCliente=${@Model.IdCliente}&page=${page}&pageSize=${pageSize}&search=${encodedSearch}`)
                .then(r => r.json());
        }

        razonDropdown.dataProvider.loadData = async ({page, pageSize, search}) => {
            const encodedSearch = encodeURIComponent(search);
            return await fetch(`@Url.Action("DropdownClienteRazonSolcial", "Cliente")?idCliente=${@Model.IdCliente}&page=${page}&pageSize=${pageSize}&search=${encodedSearch}`)
                .then(r => r.json());
        }


        contactoDropdown.setAttribute('selected', '@((Model.IdClienteContacto ?? 0) > 0 ? Model.IdClienteContacto.ToString() : "")');
        razonDropdown.setAttribute('selected', '@((Model.IdClienteRazonSolcial ?? 0) > 0 ? Model.IdClienteRazonSolcial.ToString() : "")');
    </script>
    <script>

        function isError(json) {
            if (!json.ok) {
                //  alert(json.msg);
                showToast("Error", json.msg ?? "Ocurrió un error", "error");
                return true;
            }
            return false;

        }


        const idCotizacion = @Model.IdCotizacion;
        const esAdmin = @UserClaimsHelper.IsAdmin(User).ToString().ToLower();

        async function cargarTabla() {
            const res = await fetch(`@Url.Action("GetDetalles", "Cotizacion", new { idCotizacion = Model.IdCotizacion })`);
            const data = await res.json();

            const tbody = document.querySelector("#tablaDetalle tbody");
            tbody.innerHTML = "";
            data.forEach(d => {
                if (esAdmin) {
                    tbody.insertAdjacentHTML("beforeend", `
                    <tr data-id="${d.idCotizacionDetalle}" data-mode="view">
                        <td>${d.codigo}</td>
                        <td>${d.descripcion}</td>
                        <td class="precio-lista">${d.precioListaMxn.toLocaleString("es-MX", {
                        style: "currency",
                        currency: "MXN"
                    })}</td>
                        <td class="porc-proveedor text-center">${d.porcentajeProveedor}</td>
                        <td class="precio-proveedor">${d.precioProveedor.toLocaleString("es-MX", {
                        style: "currency",
                        currency: "MXN"
                    })}</td>
                        <td class="porc-ganancia text-center">${d.porcentajeProveedorGanancia}</td>
                        <td class="ganancia">${d.gananciaProveedor}</td>
                        <td class="precio-sein">${d.precioSein.toLocaleString("es-MX", {
                        style: "currency",
                        currency: "MXN"
                    })}</td>
                        <td class="precio-cliente">${d.precioCliente.toLocaleString("es-MX", {
                        style: "currency",
                        currency: "MXN"
                    })}</td>
                        <td class="cantidad text-center">
                             <span class="valor">${d.cantidad}</span>
                                <input class="form-control form-control-sm d-none"
                                       type="number"
                                       step="1"
                                       value="${d.cantidad}">
                        </td>

                        <td class="total">${d.total.toLocaleString("es-MX", {style: "currency", currency: "MXN"})}</td>
                        <td class="obs">
                            <span class="valor">${d.observaciones ?? ""}</span>
                                <input class="form-control form-control-sm d-none"
                                       value="${d.observaciones ?? ""}">
                        </td>
                        <td class="acciones"></td>
                    </tr>
                `);
                } else {
                    tbody.insertAdjacentHTML("beforeend", `
                    <tr data-id="${d.idCotizacionDetalle}" data-mode="view">
                        <td>${d.codigo}</td>
                        <td>${d.descripcion}</td>
                        <td  class="precio-cliente">${d.precioCliente.toLocaleString("es-MX", {
                        style: "currency",
                        currency: "MXN"
                    })}</td>
                        <td class="cantidad text-center">
                             <span class="valor">${d.cantidad}</span>
                                <input class="form-control form-control-sm d-none"
                                       type="number"
                                       step="1"
                                       value="${d.cantidad}">
                        </td>

                        <td class="total">${d.total.toLocaleString("es-MX", {style: "currency", currency: "MXN"})}</td>
                        <td class="obs">
                            <span class="valor">${d.observaciones ?? ""}</span>
                                <input class="form-control form-control-sm d-none"
                                       value="${d.observaciones ?? ""}">
                        </td>
                        <td class="acciones"></td>
                    </tr>
                `);
                }

                const tr = tbody.lastElementChild;
                renderAcciones(tr);
            });

        }

        function actualizarFilaDesdeModelo(tr, d) {

            if (!d) {
                console.error("Modelo inválido en actualizarFilaDesdeModelo", d);
                return;
            }

            // ===== CANTIDAD =====
            const tdCantidad = tr.querySelector(".cantidad");
            if (tdCantidad) {
                tdCantidad.querySelector(".valor").textContent = d.cantidad;
                tdCantidad.querySelector("input").value = d.cantidad;
            }

            // ===== OBSERVACIONES =====
            const tdObs = tr.querySelector(".obs");
            if (tdObs) {
                tdObs.querySelector(".valor").textContent = d.observaciones ?? "";
                tdObs.querySelector("input").value = d.observaciones ?? "";
            }

            // ===== PRECIOS Y PORCENTAJES (ADMIN) =====
            setMoney(tr, ".precio-lista", d.precioListaMxn);
            setText(tr, ".porc-proveedor", d.porcentajeProveedor);
            setMoney(tr, ".precio-proveedor", d.precioProveedor);
            setText(tr, ".porc-ganancia", d.porcentajeProveedorGanancia);
            setMoney(tr, ".ganancia", d.gananciaProveedor);
            setMoney(tr, ".precio-sein", d.precioSein);

            // ===== COMUNES =====
            setMoney(tr, ".precio-cliente", d.precioCliente);
            setMoney(tr, ".total", d.total);

            // ===== REGRESAR A MODO VISTA =====
            tr.dataset.mode = "view";
            tr.querySelectorAll("input").forEach(i => i.classList.add("d-none"));
            tr.querySelectorAll(".valor").forEach(s => s.classList.remove("d-none"));

            renderAcciones(tr);
        }

        /* ================= HELPERS ================= */

        function setMoney(tr, selector, value) {
            const td = tr.querySelector(selector);
            if (!td || value == null) return;

            td.textContent = value.toLocaleString("es-MX", {
                style: "currency",
                currency: "MXN"
            });
        }

        function setText(tr, selector, value) {
            const td = tr.querySelector(selector);
            if (!td || value == null) return;

            td.textContent = value;
        }

        // Agregar producto
        document.querySelector("#btnAgregarProducto").addEventListener("click", async () => {
            const Comboprod = document.querySelector("#IdProducto");
            let prod = Comboprod.selected;
            let txtCant = document.querySelector("#txtCantidad");
            let txtObs = document.querySelector("#txtObsProd");

            let payload = {
                IdCotizacion: parseInt(idCotizacion),
                IdProducto: parseInt(prod),
                Cantidad: txtCant.value,
                Observaciones: txtObs.value,
            };

            const res = await fetch('@Url.Action("AgregarProducto", "Cotizacion")', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (isError(json)) {
                return;
            }
            Comboprod.setAttribute("selected", "")

            txtCant.value = 1;
            txtObs.value = "";

            await recargarTotales();
            await cargarTabla();
            showToast("Producto agregado", "Se agregó el producto correctamente");


        });

        async function eliminarDetalle(btn) {
            const tr = btn.closest("tr");
            const id = tr.dataset.id;

            const res = await fetch(
                `@Url.Action("DeleteProducto", "Cotizacion")?idDetalle=${id}`,
                {method: "DELETE"}
            );

            if (!res.ok) {
                showToast("Error", "No se pudo eliminar", "error");
                return;
            }
            const json = await res.json();
            if (isError(json)) {
                return;
            }

            tr.remove();
            await recargarTotales();
            showToast("Producto eliminado", "Se eliminó correctamente");
        }

        async function recargarTotales() {
            const res = await fetch(`@Url.Action("GetTotales", "Cotizacion", new { idCotizacion = Model.IdCotizacion })`);
            const json = await res.json();
            if (isError(json)) {
                location.reload();
            }

            const infoTotal = document.getElementById("infoTotal");
            const infoSubTotal = document.getElementById("infoSubTotal");
            const infoIva = document.getElementById("infoIva");

            infoTotal.textContent = json.total?.toLocaleString("es-MX", {style: "currency", currency: "MXN"});
            infoSubTotal.textContent = json.subTotal?.toLocaleString("es-MX", {style: "currency", currency: "MXN"});
            infoIva.textContent = json.iva?.toLocaleString("es-MX", {style: "currency", currency: "MXN"});

        }

        function renderAcciones(tr) {
            const acciones = tr.querySelector(".acciones");
            acciones.classList.add("d-flex", "gap-1", "justify-content-center");

            if (tr.dataset.mode === "edit") {
                acciones.innerHTML = `
            <button class="btn btn-success btn-sm" onclick="guardarDetalle(this)">
                <i class="fas fa-save"></i>
            </button>
            <button class="btn btn-secondary btn-sm" onclick="cancelarEdicion(this)">
                <i class="fas fa-times"></i>
            </button>`;
                return;
            }

            acciones.innerHTML = `
            <button class="btn btn-primary btn-sm" onclick="editarDetalle(this)">
                <i class="fas fa-pen-to-square"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="eliminarDetalle(this)">
                <i class="fas fa-trash"></i>
            </button>`;
        }

        function editarDetalle(btn) {
            const tr = btn.closest("tr");
            tr.dataset.mode = "edit";

            tr.querySelectorAll(".valor").forEach(s => s.classList.add("d-none"));
            tr.querySelectorAll("input").forEach(i => {
                i.classList.remove("d-none");
                i.disabled = false;
            });

            renderAcciones(tr);
        }

        function cancelarEdicion(btn) {
            const tr = btn.closest("tr");
            tr.dataset.mode = "view";

            tr.querySelectorAll(".valor").forEach(s => s.classList.remove("d-none"));
            tr.querySelectorAll("input").forEach(i => i.classList.add("d-none"));

            renderAcciones(tr);
        }

        async function guardarDetalle(btn) {
            const tr = btn.closest("tr");

            const payload = {
                IdCotizacionDetalle: parseInt(tr.dataset.id),
                Cantidad: parseFloat(tr.querySelector(".cantidad input").value),
                Observaciones: tr.querySelector(".obs input").value
            };

            if (payload.Cantidad <= 0) {
                tr.querySelector(".cantidad input").classList.add("is-invalid");
                return;
            }

            tr.querySelector(".cantidad input").classList.remove("is-invalid");

            try {

                const res = await fetch(`@Url.Action("AgregarProducto", "Cotizacion")`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload)
                });


                if (!res.ok) {
                    showToast(
                        "Error",
                        `Error del servidor (${res.status})`,
                        "error"
                    );
                    return;
                }

                const json = await res.json();
                if (isError(json)) return;


                const model = json.data;
                console.log(model)
                actualizarFilaDesdeModelo(tr, model);

                tr.dataset.id = model.idCotizacionDetalle;
                tr.dataset.mode = "view";
                renderAcciones(tr);

                await recargarTotales();
                showToast("Producto actualizado", "Se modificó correctamente");

            } catch (err) {
                console.log(err)
              await  cargarTabla();
                showToast(
                    "Error",
                    "No se pudo conectar con el servidor.",
                    "error"
                );
            }


        }


        // Inicial
        cargarTabla();

    </script>


</div>






