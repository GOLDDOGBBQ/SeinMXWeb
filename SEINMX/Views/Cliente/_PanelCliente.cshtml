@model SEINMX.Context.Database.Cliente

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-user"></i> Cliente: @Model.Nombre
        </div>
        <button class="btn btn-success btn-sm" onclick="guardarCliente()">
            <i class="fas fa-save"></i> Guardar
        </button>
    </div>

    <div class="card-body">

        <!-- FORM CLIENTE -->
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label">Nombre</label>
                <input id="cliNombre" class="form-control" value="@Model.Nombre"/>
            </div>

            <div class="col-md-6 mb-2">
                <label class="form-label">Tarifa</label>
                <input id="cliTarifa" type="number" step="0.01" class="form-control" value="@Model.Tarifa"/>
            </div>

            <div class="col-md-12 mb-2">
                <label class="form-label">Dirección</label>
                <textarea id="cliDireccion" class="form-control">@Model.Direccion</textarea>
            </div>

            <div class="col-md-12 mb-2">
                <label class="form-label">Observaciones</label>
                <textarea id="cliObs" class="form-control">@Model.Observaciones</textarea>
            </div>

            <input type="hidden" id="cliId" value="@Model.IdCliente"/>
        </div>

        <hr/>

        <!-- CONTACTOS -->
        <h5><i class="fas fa-address-book"></i> Contactos</h5>

        <div class="row g-2 mb-2">
            <div class="col-md-3">
                <input id="ctNombre" class="form-control" placeholder="Nombre"/>
            </div>
            <div class="col-md-3">
                <input id="ctTel" class="form-control" placeholder="Teléfono"/>
            </div>
            <div class="col-md-3">
                <input id="ctCorreo" class="form-control" placeholder="Correo"/>
            </div>
            <div class="col-md-3 d-grid">
                <button class="btn btn-primary" onclick="guardarContacto()">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
        </div>

        <table class="table table-sm table-striped">
            <thead class="table-light">
            <tr>
                <th>Nombre</th>
                <th>Teléfono</th>
                <th>Correo</th>
                <th class="text-end">Opciones</th>
            </tr>
            </thead>
            <tbody id="listaContactos">
            @foreach (var c in Model.ClienteContactos)
            {
                <tr id="cont_@c.IdClienteContacto">
                    <td>@c.Nombre</td>
                    <td>@c.Telefono</td>
                    <td>@c.Correo</td>
                    <td class="text-end">
                        <button class="btn btn-danger btn-sm" onclick="borrarContacto(@c.IdClienteContacto)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>

        <hr/>

        <!-- RAZONES SOCIALES -->
        <h5><i class="fas fa-file-invoice"></i> Razones Sociales</h5>

        <div class="row g-2 mb-2">
            <div class="col-md-3">
                <input id="rzRFC" class="form-control" placeholder="RFC"/>
            </div>
            <div class="col-md-3">
                <input id="rzRazon" class="form-control" placeholder="Razón Social"/>
            </div>
            <div class="col-md-3">
                <input id="rzDom" class="form-control" placeholder="Domicilio"/>
            </div>
            <div class="col-md-3 d-grid">
                <button class="btn btn-primary" onclick="guardarRazon()">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
        </div>

        <table class="table table-sm table-striped">
            <thead class="table-light">
            <tr>
                <th>RFC</th>
                <th>Razón Social</th>
                <th>Domicilio</th>
                <th class="text-end">Opciones</th>
            </tr>
            </thead>
            <tbody id="listaRazones">
            @foreach (var r in Model.ClienteRazonSolcials)
            {
                <tr id="rz_@r.IdClienteRazonSolcial">
                    <td>@r.Rfc</td>
                    <td>@r.RazonSocial</td>
                    <td>@r.Domicilio</td>
                    <td class="text-end">
                        <button class="btn btn-danger btn-sm" onclick="borrarRazon(@r.IdClienteRazonSolcial)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>

    </div>
</div>

<script>
    // =====================================================
    // GUARDAR CLIENTE
    // =====================================================
    async function guardarCliente() {
        let payload = {
            idCliente: parseInt(document.getElementById("cliId").value),
            nombre: document.getElementById("cliNombre").value,
            direccion: document.getElementById("cliDireccion").value,
            observaciones: document.getElementById("cliObs").value,
            tarifa: parseFloat(document.getElementById("cliTarifa").value) || 0,
            idTipo: 0
        };

        let res = await fetch('/Cliente/GuardarCliente', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            alert("Error al guardar el cliente.");
            return;
        }

        let data = await res.json(); // 👈 Recibimos el cliente con Id asignado

        // 🔥 Notificar al INDEX
        if (typeof onClienteGuardado === "function") {
            onClienteGuardado(data);
        }

        // Cerrar modal
        $("#modalCliente").modal("hide");
    }


    // =====================================================
    // CONTACTOS
    // =====================================================
    async function guardarContacto() {

        let payload = {
            idClienteContacto: 0,
            idCliente: parseInt(document.getElementById("cliId").value),
            nombre: document.getElementById("ctNombre").value,
            telefono: document.getElementById("ctTel").value,
            correo: document.getElementById("ctCorreo").value
        };

        let res = await fetch('/Cliente/GuardarContacto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            location.reload();
        }
    }

    async function borrarContacto(id) {
        if (!confirm("¿Eliminar contacto?")) return;

        let res = await fetch(`/Cliente/BorrarContacto?id=${id}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            document.getElementById("cont_" + id)?.remove();
        }
    }

    // =====================================================
    // RAZONES SOCIALES
    // =====================================================
    async function guardarRazon() {

        let payload = {
            idClienteRazonSolcial: 0,
            idCliente: parseInt(document.getElementById("cliId").value),
            rfc: document.getElementById("rzRFC").value,
            razonSocial: document.getElementById("rzRazon").value,
            domicilio: document.getElementById("rzDom").value,
            esPublicoGeneral: false,
            observaciones: ""
        };

        let res = await fetch('/Cliente/GuardarRazon', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            location.reload();
        }
    }

    async function borrarRazon(id) {
        if (!confirm("¿Eliminar razón social?")) return;

        let res = await fetch(`/Cliente/BorrarRazon?id=${id}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            document.getElementById("rz_" + id)?.remove();
        }
    }

</script>
